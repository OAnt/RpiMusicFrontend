var baseApp=angular.module("baseApp",["ngRoute","ngProgress","uiSlider","ngResource"]);baseApp.directive("myDropdown",function(){return{restrict:"E",transclude:!0,scope:{type:"@"},controller:function(a){a.show=!1;a.showDropdown=function(){a.show=!a.show}},templateUrl:"/static/my-dropdown.html"}});
baseApp.service("loginService",function(a){this.connectCallBack=function(){};this.connect=function(c,d,f){var e=null,g=this.connectCallBack;void 0!=d&&a({withCredentials:!0,method:"post",url:c,data:d}).success(function(a){"True"==a&&(e=d.name);f(e);g()})};this.disconnectCallBack=function(){};this.disconnect=function(c){a.get(c);this.disconnectCallBack()};this.init=function(c,d){a.get(c).success(d)}});
baseApp.config(["$routeProvider","$locationProvider",function(a,c){a.when("/",{templateUrl:"/summary.html"}).when("/pimusic",{templateUrl:"pimusic/",controller:"SongSelectionCtrl"}).when("/musicshare",{templateUrl:"musicshare/",controller:"SongSearchCtrl"});c.html5Mode(!0)}]);
baseApp.controller("loginController",function(a,c,d){a.loginWindow=!1;a.error=null;a.logged={};a.logged.loggedin=!1;a.logged.name=null;a.showWindow=function(){a.loginWindow=!a.loginWindow;a.error=null};a.login=function(c){d.connect("/musicshare/login/",c,function(d){null==d?a.error="Login Error":(a.loginWindow=!1,a.logged.loggedin=!0,a.error=null);a.logged.name=d;c=null})};a.logout=function(){d.disconnect("/musicshare/logout/");a.logged.loggedin=!1;a.logged.name=null;a.error=null};d.init("/musicshare/login/",
function(d){""!=d?(a.logged.loggedin=!0,a.logged.name=d):a.logged.loggedin=!1});d.connectCallBack=function(){};d.disconnectCallBack=function(){}});
baseApp.controller("signinController",function(a,c){a.signinForm={};a.signinForm.show="false";a.error=null;a.signin=function(){a.signinForm.show=a.signinForm.show?!1:!0};a.sign=function(d){if(void 0!=d&&void 0!=d.name&&void 0!=d.password&&d.password==d.passwordConf){var f={};f.name=d.name;f.password=d.password;c({withCredentials:!0,method:"post",url:"/musicshare//signin/",data:f}).success(function(c){"true"==c?(a.error=null,a.signinForm.show="false",window.alert(d.name+" successfully registered")):
a.error="User already exists";d.name="";d.password="";d.passwordConf=""})}else a.error="Identification error"}});
baseApp.controller("SongSearchCtrl",function(a,c,d,f){a.songsList=[];a.playList=[];a.songNumber=0;a.loadedLists=[];a.logged={};a.logged.show=!1;a.logged.name="";a.songSelection=!1;a.playListBool=!1;a.songBeingPlayed=0;a.activeSong=!1;var e=d.find("audio")[0],g=document.getElementById("fileInput");a.search=function(b){a.transmit=b;c.post("/musicshare/",b).success(function(b){"false"!=b&&(a.songs=b,a.songSelection=!0)})};a.addSong=function(b){a.songsList.push(b);a.songNumber++;e.autoplay=!1;1==a.songNumber&&
(a.activeSong=a.songsList[0])};a.remSong=function(b){b=a.songsList.indexOf(b);-1!=b&&(a.songsList.splice(b,1),a.songNumber--)};a.saveList=function(){var b=window.prompt("Please name the list","something");c.post("/musicshare/playlist/",[b,a.songsList]).success(function(b){"true"==b&&a.getLists()})};a.clearList=function(){a.songsList=[];a.songNumber=0};a.getLists=function(){c.get("/musicshare//playlist/").success(function(b){"None"!=b?(a.loadedLists=b,a.playListBool=!0):a.playListBool=!1})};a.loadList=
function(b){c.post("/musicshare//rplaylist/",b[0]).success(function(b){a.songsList=b;a.songNumber=a.songsList.length;a.songBeingPlayed=0;a.changeSong();e.autoplay=!1})};a.dropList=function(b){window.prompt("Verify the name of list to drop","")==b[1]&&c["delete"]("/musicshare//playlist/?id="+b[0]).success(function(){window.alert(b[1]+" successfully dropped");a.getLists()})};g.addEventListener("change",function(){var b=new FileReader,d=g.files;if(0<d.length)for(var e=0;e<d.length;e++)b.readAsBinaryString(d[e]),
b.onloadend=e==d.length-1?function(){c({withCredentials:!0,method:"post",url:"/musicshare//upload/",data:b.result}).success(function(b){a.getLists();g.value=null})}:function(){c({withCredentials:!0,method:"post",url:"/musicshare//upload/",data:b.result})}});e.addEventListener("ended",function(){e.autoplay=!0;a.$apply(a.nextSong())});a.moveDown=function(b){b=a.songsList.indexOf(b);b<a.songNumber-1&&a.songsList.splice(b+1,0,a.songsList.splice(b,1)[0])};a.moveUp=function(b){b=a.songsList.indexOf(b);
0<b&&a.songsList.splice(b-1,0,a.songsList.splice(b,1)[0])};a.prevSong=function(){0<a.songBeingPlayed&&(a.songBeingPlayed--,a.changeSong(),e.autoplay=!0)};a.nextSong=function(){a.songBeingPlayed<a.songNumber-1?(a.songBeingPlayed++,a.changeSong(),e.autoplay=!0):(a.songBeingPlayed=0,a.changeSong(),e.autoplay=!1)};a.changeSong=function(){a.activeSong=a.songsList[a.songBeingPlayed]};f.init("/musicshare/login/",function(b){"None"!=b?(a.logged.show=!0,a.logged.name=b,a.getLists()):a.logged.show=!1});f.connectCallBack=
function(){a.logged.show=!0;a.getLists()};f.disconnectCallBack=function(){a.logged.show=!1;a.loadedLists=[]}});
baseApp.controller("SongSelectionCtrl",function(a,c,d,f){a.autoVolumeChangeInProgress=!1;a.artists=[];a.albums=[];a.songs=[];a.output=null;a.metadata=Object(null);a.paused=!1;a.songList=Object(null);a.volume=null;var e=new WebSocket("ws://"+document.domain+":5000/api");e.onopen=function(){a.$watch("volume",function(){a.autoVolumeChangeInProgress||"NaN"==a.volume||e.send("volume:"+parseInt(a.volume)+"\n")})};a.playSong=function(a){c.post("/pimusic/music/"+a[3]+"/"+a[2]+"/"+a[0],a)};a.getSongs=function(d){c.get("/pimusic/music/"+
d[2]+"/"+d[0]).success(function(b){a.songs=b})};a.getAlbums=function(d){c.get("/pimusic/music/"+d[0]).success(function(b){a.albums=b})};a.pause_unpause=function(){c.get("/pimusic/player/pause")};a.nextSong=function(){c.get("/pimusic/player/next")};a.prevSong=function(){c.get("/pimusic/player/previous")};(function(){c.get("/pimusic/music").success(function(d){a.artists=d});e.onmessage=function(c){console.log("Received message: %s",c.data);c=JSON.parse(c.data);switch(c.message){case "ANS_PERCENT_POSITION":a.output=
c.value;d.set(parseInt(c.value));break;case "Title":case "ANS_META_TITLE":a.metadata.title=c.value;break;case "Artist":case "ANS_META_ARTIST":a.metadata.artist=c.value;break;case "Album":case "ANS_META_ALBUM":a.metadata.album=c.value;break;case "ANS_pause":a.paused="yes"==c.value?!0:!1;break;case "list":a.songList.list=c.value;break;case "index":a.songList.index=c.value;break;case "ANS_volume":a.autoVolumeChangeInProgress=!0;a.volume=c.value;break;default:console.log("Unknown: %s",c.message)}a.$apply();
a.autoVolumeChangeInProgress=!1}})();f.init("/musicshare/login/",function(a){});f.connectCallBack=function(){};f.disconnectCallBack=function(){}});
